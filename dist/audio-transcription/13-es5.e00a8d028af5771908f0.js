function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function asyncGeneratorStep(e,t,r,n,a,i,o){try{var s=e[i](o),c=s.value}catch(l){return void r(l)}s.done?t(c):Promise.resolve(c).then(n,a)}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var i=e.apply(t,r);function o(e){asyncGeneratorStep(i,n,a,o,s,"next",e)}function s(e){asyncGeneratorStep(i,n,a,o,s,"throw",e)}o(void 0)}))}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{OkRK:function(e,t,r){"use strict";r.r(t),r.d(t,"amplify_chatbot",(function(){return b}));var n,a,i,o=r("bRKV"),s=r("Nt7R"),c=r("HzrR"),l=r("JIIv"),u=r("vbTL"),h=r("/vcS"),d=r("tZc9"),f=function(e,t,r){for(var n=0;n<r.length;n++)e.setUint8(t+n,r.charCodeAt(n))},m=new s.a("AudioRecorder"),p=function(){function e(t){_classCallCheck(this,e),this.streamBuffer=[],this.streamBufferLength=0,this.recording=!1,this.options=t}var t,r,n,a;return _createClass(e,[{key:"init",value:(a=_asyncToGenerator(regeneratorRuntime.mark((function e(){var t=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Object(c.b)().isBrowser){e.next=2;break}return e.abrupt("return",(this.audioSupported=!1,Promise.reject("Audio is not supported")));case 2:return window.AudioContext=window.AudioContext||window.webkitAudioContext,this.audioContext=new AudioContext,e.next=6,navigator.mediaDevices.getUserMedia({audio:!0}).then((function(e){t.audioSupported=!0,t.setupAudioNodes(e)})).catch((function(){return t.audioSupported=!1,Promise.reject("Audio is not supported")}));case 6:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"setupAudioNodes",value:(n=_asyncToGenerator(regeneratorRuntime.mark((function e(t){var r,n,a,i=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.audioContext.resume();case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),m.error(e.t0);case 8:r=this.audioContext.createMediaStreamSource(t),(n=this.audioContext.createScriptProcessor(4096,1,1)).onaudioprocess=function(e){if(i.recording){var t=e.inputBuffer.getChannelData(0);i.streamBuffer.push(new Float32Array(t)),i.streamBufferLength+=t.length,i.analyse()}},(a=this.audioContext.createAnalyser()).minDecibels=-90,a.maxDecibels=-10,a.smoothingTimeConstant=.85,r.connect(a),a.connect(n),n.connect(r.context.destination),this.analyserNode=a;case 12:case"end":return e.stop()}}),e,this,[[0,5]])}))),function(e){return n.apply(this,arguments)})},{key:"startRecording",value:(r=_asyncToGenerator(regeneratorRuntime.mark((function e(t,r){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.recording&&this.audioSupported){e.next=2;break}return e.abrupt("return");case 2:return this.onSilence=t||function(){},this.visualizer=r||function(){},n=this.audioContext,e.prev=4,e.next=7,n.resume();case 7:e.next=12;break;case 9:e.prev=9,e.t0=e.catch(4),m.error(e.t0);case 12:this.start=Date.now(),this.recording=!0;case 13:case"end":return e.stop()}}),e,this,[[4,9]])}))),function(e,t){return r.apply(this,arguments)})},{key:"stopRecording",value:function(){this.audioSupported&&(this.recording=!1)}},{key:"clear",value:function(){this.stopRecording(),this.streamBufferLength=0,this.streamBuffer=[]}},{key:"play",value:function(e){var t=this;if(e&&this.audioSupported){var r=new Blob([e]);return new Promise((function(e,n){var a=new FileReader;a.onload=function(){t.playbackSource&&t.playbackSource.disconnect(),t.playbackSource=t.audioContext.createBufferSource(),t.audioContext.decodeAudioData(a.result,(function(r){t.playbackSource.buffer=r,t.playbackSource.connect(t.audioContext.destination),t.playbackSource.onended=function(){return e()},t.playbackSource.start(0)}),(function(e){return n(e)}))},a.onerror=function(){return n()},a.readAsArrayBuffer(r)}))}}},{key:"stop",value:function(){this.playbackSource&&this.playbackSource.stop()}},{key:"analyse",value:function(){if(this.audioSupported){var e=this.analyserNode;e.fftSize=2048;var t=e.fftSize,r=new Uint8Array(t),n=this.options.amplitude,a=this.options.time;e.getByteTimeDomainData(r),this.visualizer(r,t);for(var i=0;i<t;i++){var o=r[i]/128-1;(o>n||o<-1*n)&&(this.start=Date.now())}Date.now()-this.start>a&&this.onSilence()}}},{key:"exportWAV",value:(t=_asyncToGenerator(regeneratorRuntime.mark((function e(){var t,r,n=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=n.length>0&&void 0!==n[0]?n[0]:16e3,this.audioSupported){e.next=3;break}return e.abrupt("return");case 3:return r=function(e,t,r,n){var a=function(e,t){var r=2*e.length,n=8+r,a=new ArrayBuffer(36+n),i=new DataView(a);return f(i,0,"RIFF"),i.setUint32(4,24+n,!0),f(i,8,"WAVE"),f(i,12,"fmt "),i.setUint32(16,16,!0),i.setUint16(20,1,!0),i.setUint16(22,1,!0),i.setUint32(24,t,!0),i.setUint32(28,2*t,!0),i.setUint16(32,2,!0),i.setUint16(34,16,!0),f(i,36,"data"),i.setUint32(40,r,!0),function(e,t,r){for(var n=44,a=0;a<r.length;a++,n+=2){var i=Math.max(-1,Math.min(1,r[a]));e.setInt16(n,i<0?32768*i:32767*i,!0)}}(i,0,e),i}(function(e,t,r){if(r===t)return e;for(var n=t/r,a=Math.round(e.length/n),i=new Float32Array(a),o=0,s=0;o<i.length;){for(var c=Math.round((o+1)*n),l=0,u=0,h=s;h<c&&h<e.length;h++)l+=e[h],u++;i[o]=l/u,o++,s=c}return i}(function(e,t){for(var r=new Float32Array(t),n=0,a=0;a<e.length;a++)r.set(e[a],n),n+=e[a].length;return r}(e,t),r,n),n);return new Blob([a],{type:"application/octet-stream"})}(this.streamBuffer,this.streamBufferLength,this.audioContext.sampleRate,t),e.abrupt("return",(this.clear(),r));case 5:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),e}();!function(e){e[e.Initial=0]="Initial",e[e.Listening=1]="Listening",e[e.SendingText=2]="SendingText",e[e.SendingVoice=3]="SendingVoice",e[e.Error=4]="Error"}(n||(n={})),function(e){e.Bot="bot",e.User="user"}(a||(a={})),function(e){e[e.Recoverable=0]="Recoverable",e[e.Unrecoverable=1]="Unrecoverable"}(i||(i={}));var b=function(){function e(t){var r=this;_classCallCheck(this,e),Object(o.k)(this,t),this.clearOnComplete=!1,this.conversationModeOn=!1,this.botTitle=u.a.CHATBOT_TITLE,this.voiceEnabled=!1,this.textEnabled=!0,this.silenceTime=1500,this.silenceThreshold=.2,this.messages=[],this.text="",this.chatState=n.Initial,this.messageJSX=function(e){var t=e.map((function(e){return Object(o.i)("div",{class:"bubble "+e.from},e.content)}));if(r.chatState===n.SendingText||r.chatState===n.SendingVoice){var i=r.chatState===n.SendingText?a.Bot:a.User;t.push(Object(o.i)("div",{class:"bubble "+i},Object(o.i)("div",{class:"dot-flashing "+i},Object(o.i)("span",{class:"dot left"}),Object(o.i)("span",{class:"dot middle"}),Object(o.i)("span",{class:"dot right"}))))}return t},this.chatCompleted=Object(o.f)(this,"chatCompleted",7)}var t,r;return _createClass(e,[{key:"submitHandler",value:function(e){this.sendTextMessage()}},{key:"componentWillLoad",value:function(){if(!d.a||"function"!=typeof d.a.onComplete)throw new Error(h.m);this.validateProps()}},{key:"componentDidRender",value:function(){var e=this.element.shadowRoot.querySelector(".body");e.scrollTop=e.scrollHeight}},{key:"validateProps",value:function(){var e=this;if(this.voiceEnabled||this.textEnabled)if(this.botName){this.welcomeMessage&&this.appendToChat(this.welcomeMessage,a.Bot),this.voiceEnabled&&(this.audioRecorder=new p({time:this.silenceTime,amplitude:this.silenceThreshold}),this.audioRecorder.init().catch((function(t){e.setError(t,i.Recoverable)})));try{d.a.onComplete(this.botName,(function(t,r){e.chatCompleted.emit({data:r,err:t}),e.clearOnComplete?e.reset():e.chatState=n.Initial}))}catch(t){this.setError(t,i.Unrecoverable)}}else this.setError(u.a.NO_BOT_NAME_ERROR,i.Unrecoverable);else this.setError(u.a.CHAT_DISABLED_ERROR,i.Unrecoverable)}},{key:"handleMicButton",value:function(){var e=this;this.chatState===n.Initial&&(this.audioRecorder.stop(),this.chatState=n.Listening,this.audioRecorder.startRecording((function(){return e.handleSilence()}),(function(t,r){return e.visualizer(t,r)})))}},{key:"handleSilence",value:function(){var e=this;this.chatState=n.SendingVoice,this.audioRecorder.stopRecording(),this.audioRecorder.exportWAV().then((function(t){e.sendVoiceMessage(t)}))}},{key:"handleTextChange",value:function(e){this.text=e.target.value}},{key:"handleCancelButton",value:function(){this.audioRecorder.clear(),this.chatState=n.Initial}},{key:"handleToastClose",value:function(e){this.error=void 0,e===i.Recoverable&&(this.chatState=n.Initial)}},{key:"visualizer",value:function(e,t){!function(e,t,r){if(r){if(!Object(c.b)().isBrowser)throw new Error("Visualization is not supported on non-browsers.");var n=r.getBoundingClientRect(),a=n.width,i=n.height;r.width=a,r.height=i;var o=r.getContext("2d");o.fillStyle="white",o.clearRect(0,0,a,i),requestAnimationFrame((function(){o.fillRect(0,0,a,i),o.lineWidth=1;var n=getComputedStyle(document.documentElement).getPropertyValue("--amplify-primary-color");o.strokeStyle=n&&""!==n?n:"#ff9900",o.beginPath();for(var s=1*a/t,c=0,l=0;l<t||l%3==0;l++){var u=e[l]/128*i/2;0===l?o.moveTo(c,u):o.lineTo(c,u),c+=s}o.lineTo(r.width,r.height/2),o.stroke()}))}}(e,t,this.element.shadowRoot.querySelector("canvas"))}},{key:"sendTextMessage",value:(r=_asyncToGenerator(regeneratorRuntime.mark((function e(){var t,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==this.text.length&&this.chatState===n.Initial){e.next=2;break}return e.abrupt("return");case 2:return t=this.text,this.text="",this.appendToChat(t,a.User),this.chatState=n.SendingText,e.prev=4,e.next=7,d.a.send(this.botName,t);case 7:r=e.sent,e.next=13;break;case 10:return e.prev=10,e.t0=e.catch(4),e.abrupt("return",void this.setError(e.t0,i.Recoverable));case 13:r.message&&this.appendToChat(r.message,a.Bot),this.chatState=n.Initial;case 14:case"end":return e.stop()}}),e,this,[[4,10]])}))),function(){return r.apply(this,arguments)})},{key:"sendVoiceMessage",value:(t=_asyncToGenerator(regeneratorRuntime.mark((function e(t){var r,o,s,c=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={content:t,options:{messageType:"voice"}},e.prev=1,e.next=4,d.a.send(this.botName,r);case 4:o=e.sent,e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(1),e.abrupt("return",void this.setError(e.t0,i.Recoverable));case 10:return this.chatState=n.Initial,s=o.dialogState,o.inputTranscript&&this.appendToChat(o.inputTranscript,a.User),this.appendToChat(o.message,a.Bot),e.next=16,this.audioRecorder.play(o.audioStream).then((function(){c.conversationModeOn&&"Fulfilled"!==s&&"Failed"!==s&&c.chatState===n.Initial&&c.handleMicButton()})).catch((function(e){return c.setError(e,i.Recoverable)}));case 16:case"end":return e.stop()}}),e,this,[[1,7]])}))),function(e){return t.apply(this,arguments)})},{key:"appendToChat",value:function(e,t){this.messages=[].concat(_toConsumableArray(this.messages),[{content:e,from:t}])}},{key:"setError",value:function(e,t){var r="string"==typeof e?e:e.message;this.chatState=n.Error,this.error={message:r,errorType:t}}},{key:"reset",value:function(){this.chatState=n.Initial,this.text="",this.error=void 0,this.messages=[],this.welcomeMessage&&this.appendToChat(this.welcomeMessage,a.Bot),this.audioRecorder&&this.audioRecorder.clear()}},{key:"listeningFooterJSX",value:function(){var e=this;return[Object(o.i)("canvas",{height:"50"}),Object(o.i)("amplify-button",{"data-test":"chatbot-cancel-button",handleButtonClick:function(){return e.handleCancelButton()},class:"icon-button",variant:"icon",icon:"ban"})]}},{key:"footerJSX",value:function(){var e=this;if(this.chatState===n.Listening)return this.listeningFooterJSX();var t=this.textEnabled?u.a.TEXT_INPUT_PLACEHOLDER:u.a.VOICE_INPUT_PLACEHOLDER;return[Object(o.i)("amplify-input",{placeholder:l.a.get(t),description:"text",handleInputChange:function(t){return e.handleTextChange(t)},value:this.text,disabled:this.chatState===n.Error||!this.textEnabled}),this.voiceEnabled&&Object(o.i)("amplify-button",{"data-test":"chatbot-mic-button",handleButtonClick:function(){return e.handleMicButton()},class:"icon-button",variant:"icon",icon:"microphone",disabled:this.chatState===n.Error||this.chatState!==n.Initial}),this.textEnabled&&Object(o.i)("amplify-button",{"data-test":"chatbot-send-button",class:"icon-button",variant:"icon",icon:"send",handleButtonClick:function(){return e.sendTextMessage()},disabled:this.chatState===n.Error||this.chatState!==n.Initial})]}},{key:"errorToast",value:function(){var e=this;if(this.error){var t=this.error,r=t.message,n=t.errorType;return Object(o.i)("amplify-toast",{message:l.a.get(r),handleClose:function(){return e.handleToastClose(n)}})}}},{key:"render",value:function(){return Object(o.i)(o.b,null,Object(o.i)("div",{class:"amplify-chatbot"},Object(o.i)("slot",{name:"header"},Object(o.i)("div",{class:"header","data-test":"chatbot-header"},l.a.get(this.botTitle))),Object(o.i)("div",{class:"body","data-test":"chatbot-body"},this.messageJSX(this.messages)),Object(o.i)("div",{class:"footer","data-test":"chatbot-footer"},this.footerJSX()),this.errorToast()))}},{key:"element",get:function(){return Object(o.h)(this)}}]),e}();b.style=".bot .dot{background-color:var(--bot-dot-color)}.user .dot{background-color:var(--user-dot-color)}.dot-flashing{width:2.625rem}.dot-flashing .dot{display:inline-block;width:0.625rem;height:0.625rem;border-radius:10rem;opacity:0.65}.dot-flashing .left{-webkit-animation:dot-flashing 1s infinite alternate;animation:dot-flashing 1s infinite alternate;-webkit-animation-delay:0s;animation-delay:0s}.dot-flashing .middle{margin-left:0.375rem;margin-right:0.375rem;-webkit-animation:dot-flashing 1s infinite linear alternate;animation:dot-flashing 1s infinite linear alternate;-webkit-animation-delay:0.5s;animation-delay:0.5s}.dot-flashing .right{-webkit-animation:dot-flashing 1s infinite alternate;animation:dot-flashing 1s infinite alternate;-webkit-animation-delay:1s;animation-delay:1s}@-webkit-keyframes dot-flashing{0%{opacity:0.65}50%,100%{opacity:0.1}}@keyframes dot-flashing{0%{opacity:0.65}50%,100%{opacity:0.1}}:host{--width:28.75rem;--height:37.5rem;--header-color:var(--amplify-secondary-color);--header-size:var(--amplify-text-lg);--bot-background-color:rgb(230, 230, 230);--bot-text-color:black;--bot-dot-color:var(--bot-text-color);--user-background-color:var(--amplify-blue);--user-text-color:var(--amplify-white);--user-dot-color:var(--user-text-color)}.amplify-chatbot{display:-ms-inline-flexbox;display:inline-flex;-ms-flex-direction:column;flex-direction:column;background-color:var(--background-color);border-radius:0.375rem;-webkit-box-shadow:0.0625rem 0rem 0.25rem 0 rgba(0, 0, 0, 0.15);box-shadow:0.0625rem 0rem 0.25rem 0 rgba(0, 0, 0, 0.15);-webkit-box-sizing:border-box;box-sizing:border-box;font-family:var(--amplify-font-family);margin-bottom:1rem;width:100%;height:var(--height);max-width:var(--width)}@media (min-width: 672px){.amplify-chatbot{width:var(--width)}}.header{padding:1.25rem 0.375rem 1.25rem 0.375rem;color:var(--header-color);font-size:var(--header-size);font-weight:bold;text-align:center;word-wrap:break-word}.body{border-top:0.0625rem solid rgba(0, 0, 0, 0.05);padding:1.5rem 1rem 0 1rem;display:-ms-flexbox;display:flex;-ms-flex-positive:1;flex-grow:1;-ms-flex-direction:column;flex-direction:column;overflow:auto}.bubble{max-width:100%;padding:0.8em 1.4em;text-align:left;word-wrap:break-word;margin-bottom:0.625rem}.bot{margin-right:auto;background-color:var(--bot-background-color);color:var(--bot-text-color);border-radius:1.5rem 1.5rem 1.5rem 0}.user{margin-left:auto;background-color:var(--user-background-color);color:var(--user-text-color);border-radius:1.5rem 1.5rem 0 1.5rem}.footer{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;border-top:0.062rem solid rgba(0, 0, 0, 0.05);padding-right:0.625rem;min-height:3.125rem}.footer amplify-input{--border:none;--margin:0;-ms-flex-positive:1;flex-grow:1}canvas{margin-left:0.625rem;margin-right:0.625rem;-ms-flex-positive:1;flex-grow:1;height:3.125rem}.icon-button{--icon-height:1.25rem;--icon-fill:var(--amplify-primary-color);--padding:0.625rem;--width:auto}"}}]);